<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .carousel-container {
            scroll-behavior: smooth;
        }
        .meal-card {
            transition: all 0.3s ease;
        }
        .meal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-active {
            background: #cc1e0f;
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body style="background-color: #cc1e0f;" class="min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <h1 class="text-lg md:text-xl font-bold text-center" style="color: #cc1e0f;">ü§î ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•!!</h1>
            <p class="text-gray-600 text-center mt-2 text-sm">‡πÄ‡∏°‡∏ô‡∏π‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏´‡∏≤‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏ó‡∏¢</p>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex justify-center space-x-4 mb-8">
            <div id="step1-indicator" class="step-indicator step-active w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">1</div>
            <div class="w-16 h-1 bg-white/30 self-center"></div>
            <div id="step2-indicator" class="step-indicator bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">2</div>
            <div class="w-16 h-1 bg-white/30 self-center"></div>
            <div id="step3-indicator" class="step-indicator bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">3</div>
            <div class="w-16 h-1 bg-white/30 self-center"></div>
            <div id="step4-indicator" class="step-indicator bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">4</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-4 pb-8">
        <!-- Step 1: Food Type Selection -->
        <div id="step1" class="bg-white rounded-2xl shadow-xl p-8 mb-6 fade-in" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-6" style="color: #cc1e0f;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö üç¥</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <button onclick="selectFoodType('thai')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üáπüá≠</div>
                    <div class="font-semibold text-sm">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</div>
                </button>
                <button onclick="selectFoodType('western')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üçù</div>
                    <div class="font-semibold text-sm">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á</div>
                </button>
                <button onclick="selectFoodType('noodles')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üçú</div>
                    <div class="font-semibold text-sm">‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</div>
                </button>
                <button onclick="selectFoodType('healthy')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">ü•ó</div>
                    <div class="font-semibold text-sm">‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                </button>
                <button onclick="selectFoodType('vegetarian')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üßò</div>
                    <div class="font-semibold text-sm">‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à</div>
                </button>
                <button onclick="selectFoodType('drinks')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üßã</div>
                    <div class="font-semibold text-sm">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</div>
                </button>
                <button onclick="selectFoodType('snacks')" class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üçø</div>
                    <div class="font-semibold text-sm">‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Number of Meals -->
        <div id="step2" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-4" style="color: #cc1e0f;">‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏¥‡∏ô‡∏Å‡∏µ‡πà‡∏°‡∏∑‡πâ‡∏≠‡∏î‡∏µ‡∏à‡πä‡∏∞? ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÜ üßÆ</h2>
            <p class="text-center text-gray-600 mb-6 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏∞ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô</p>
            <div class="flex flex-col space-y-3 mt-8">
                <button onclick="toggleMeal('breakfast')" class="meal-btn bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200 flex items-center space-x-3" data-meal="breakfast">
                    <div class="text-xl">üåÖ</div>
                    <div class="font-semibold text-sm">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</div>
                </button>
                <button onclick="toggleMeal('lunch')" class="meal-btn bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200 flex items-center space-x-3" data-meal="lunch">
                    <div class="text-xl">‚òÄÔ∏è</div>
                    <div class="font-semibold text-sm">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</div>
                </button>
                <button onclick="toggleMeal('dinner')" class="meal-btn bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200 flex items-center space-x-3" data-meal="dinner">
                    <div class="text-xl">üåÜ</div>
                    <div class="font-semibold text-sm">‡πÄ‡∏¢‡πá‡∏ô</div>
                </button>
            </div>
            <div class="text-center mt-8">
                <button id="confirmMeals" onclick="confirmMealSelection()" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                    ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
            </div>
        </div>

        <!-- Step 3: Preferences -->
        <div id="step3" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-4" style="color: #cc1e0f;">‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏´‡∏° ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô‡πÜ üí™</h2>
            <div class="grid grid-cols-2 gap-4 mt-8">
                <button onclick="selectPreference('high-protein')" class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">ü•©</div>
                    <div class="font-semibold text-sm">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á</div>
                </button>
                <button onclick="selectPreference('low-carb')" class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üßò‚Äç‚ôÄÔ∏è</div>
                    <div class="font-semibold text-sm">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥</div>
                </button>
                <button onclick="selectPreference('calorie-control')" class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üíß</div>
                    <div class="font-semibold text-sm">‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ</div>
                </button>
                <button onclick="selectPreference('just-delicious')" class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200">
                    <div class="text-2xl mb-1">üß°</div>
                    <div class="font-semibold text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</div>
                </button>
            </div>
            <div class="text-center mt-8">
                <button id="submitPreferences" onclick="submitPreferences()" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                    üçΩÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                </button>
            </div>
        </div>

        <!-- Step 4: Generated Meal Plan -->
        <div id="step4" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-6" style="color: #cc1e0f;">üç± Meal Plan ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</h2>
            
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
                <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            
            <div id="meal-plan-content" class="space-y-4 hidden">
                <!-- Meal plan will be generated here -->
            </div>
            <div id="summary-section" class="mt-8 p-4 bg-gray-50 rounded-xl hidden">
                <div id="summary" class="text-center">
                    <!-- Summary will be generated here -->
                </div>
            </div>
            
            <!-- User History Section -->
            <div id="user-history" class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200 hidden">
                <h3 class="text-base font-semibold text-blue-800 mb-3 text-center">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                <div id="history-content" class="space-y-2 text-sm text-blue-700">
                    <!-- History will be loaded here -->
                </div>
            </div>
            
            <!-- Tips Section -->
            <div id="tips-section" class="mt-6 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-200 hidden">
                <h3 class="text-base font-semibold text-orange-800 mb-3 text-center">üí° ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÜ ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•</h3>
                <div id="tips-content" class="space-y-2 text-sm text-orange-700">
                    <!-- Tips will be generated here -->
                </div>
            </div>
            <div id="action-buttons" class="flex justify-center space-x-3 mt-6 hidden">
                <button onclick="regeneratePlan()" class="bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200 text-sm">
                    üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà
                </button>
                <button onclick="goBackToStart()" class="bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-105 border border-gray-200 text-sm">
                    üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden form for data collection -->
    <form id="mealPlanForm" style="display: none;">
        <input type="hidden" id="lineId" name="lineId">
        <input type="hidden" id="foodType" name="foodType">
        <input type="hidden" id="mealCount" name="mealCount">
        <input type="hidden" id="preference" name="preference">
        <input type="hidden" id="generatedPlan" name="generatedPlan">
    </form>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co'; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM'; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Anon Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        
        // Initialize Supabase only if credentials are provided
        let supabaseClient = null;
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        let currentStep = 1;
        let selectedData = {
            foodType: '',
            meals: [],
            preference: '',
            lineId: ''
        };

        // LIFF Initialization
        async function initializeLIFF() {
            try {
                await liff.init({ liffId: "2007859046-yEGnq0GX" }); // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                selectedData.lineId = profile.userId;
                document.getElementById("lineId").value = profile.userId;
                
                console.log("LINE user ID:", profile.userId);
            } catch (error) {
                console.log("LIFF initialization failed:", error);
                // For demo purposes, generate a random ID
                selectedData.lineId = 'demo_' + Math.random().toString(36).substr(2, 9);
                document.getElementById("lineId").value = selectedData.lineId;
            }
        }

        // Initialize LIFF when page loads
        window.addEventListener('load', initializeLIFF);

        function selectFoodType(type) {
            selectedData.foodType = type;
            document.getElementById("foodType").value = type;
            
            // Visual feedback
            document.querySelectorAll('.food-type-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-yellow-300');
            });
            event.target.closest('.food-type-btn').classList.add('ring-4', 'ring-yellow-300');
            
            setTimeout(() => {
                nextStep();
            }, 500);
        }

        function toggleMeal(mealType) {
            const button = event.target.closest('.meal-btn');
            const index = selectedData.meals.indexOf(mealType);
            
            if (index > -1) {
                // Remove meal if already selected
                selectedData.meals.splice(index, 1);
                button.classList.remove('ring-4', 'ring-yellow-300', 'bg-yellow-50');
                button.classList.add('bg-white');
            } else {
                // Add meal if not selected
                selectedData.meals.push(mealType);
                button.classList.add('ring-4', 'ring-yellow-300', 'bg-yellow-50');
                button.classList.remove('bg-white');
            }
            
            // Update form value
            document.getElementById("mealCount").value = selectedData.meals.join(',');
            
            // Enable/disable confirm button
            const confirmBtn = document.getElementById('confirmMeals');
            if (selectedData.meals.length > 0) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function confirmMealSelection() {
            if (selectedData.meals.length === 0) return;
            
            // Visual feedback
            const confirmBtn = document.getElementById('confirmMeals');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
            confirmBtn.disabled = true;
            
            setTimeout(() => {
                nextStep();
            }, 500);
        }

        function selectPreference(pref) {
            selectedData.preference = pref;
            document.getElementById("preference").value = pref;
            
            // Visual feedback
            document.querySelectorAll('.pref-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-yellow-300');
            });
            event.target.closest('.pref-btn').classList.add('ring-4', 'ring-yellow-300');
            
            // Enable submit button
            const submitBtn = document.getElementById('submitPreferences');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function submitPreferences() {
            if (!selectedData.preference) return;
            
            const submitBtn = document.getElementById('submitPreferences');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            submitBtn.disabled = true;
            
            try {
                // Save user preferences to database
                const userPreferences = {
                    line_id: selectedData.lineId,
                    food_type: selectedData.foodType,
                    selected_meals: selectedData.meals.join(','),
                    preference: selectedData.preference,
                    created_at: new Date().toISOString()
                };
                
                if (supabaseClient) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('user_preferences')
                            .insert([userPreferences]);
                        
                        if (error) {
                            console.error('Database error:', error);
                            // Continue anyway - don't block the user experience
                        } else {
                            console.log('Preferences saved successfully:', data);
                        }
                    } catch (dbError) {
                        console.error('Database connection error:', dbError);
                        // Continue anyway - don't block the user experience
                    }
                } else {
                    console.log("Demo mode - preferences would be saved:", userPreferences);
                }
                
                // Always generate meal plan and proceed to next step
                await generateMealPlan();
                nextStep();
                
            } catch (error) {
                console.error('Error submitting preferences:', error);
                // Even if there's an error, try to continue with meal generation
                try {
                    await generateMealPlan();
                    nextStep();
                } catch (mealError) {
                    console.error('Error generating meal plan:', mealError);
                    submitBtn.innerHTML = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }, 2000);
                }
            }
        }

        function nextStep() {
            // Hide current step
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            
            // Update step indicator
            document.getElementById(`step${currentStep}-indicator`).classList.remove('step-active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('step-completed');
            
            // Show next step
            currentStep++;
            if (currentStep <= 4) {
                document.getElementById(`step${currentStep}`).classList.remove('hidden');
                document.getElementById(`step${currentStep}`).classList.add('fade-in');
                
                if (currentStep <= 4) {
                    document.getElementById(`step${currentStep}-indicator`).classList.remove('bg-white/30');
                    document.getElementById(`step${currentStep}-indicator`).classList.add('step-active');
                }
            }
        }

        async function generateMealPlan() {
            let meals = [];
            let totalCalories = 0;
            
            try {
                if (supabaseClient) {
                    // Query meals from database based on user preferences
                    for (const mealType of selectedData.meals) {
                        let query = supabaseClient
                            .from('meals_database')
                            .select('*');
                        
                        // Filter by food type
                        if (selectedData.foodType !== 'just-delicious') {
                            query = query.eq('food_type', selectedData.foodType);
                        }
                        
                        // Filter by meal time
                        const mealTimeMap = {
                            'breakfast': 'breakfast',
                            'lunch': 'lunch', 
                            'dinner': 'dinner'
                        };
                        
                        if (mealTimeMap[mealType]) {
                            query = query.eq('meal_time', mealTimeMap[mealType]);
                        }
                        
                        // Filter by preferences
                        if (selectedData.preference === 'high-protein') {
                            query = query.gte('protein', 15); // High protein meals
                        } else if (selectedData.preference === 'low-carb') {
                            query = query.lte('carbs', 30); // Low carb meals
                        } else if (selectedData.preference === 'calorie-control') {
                            query = query.lte('calories', 400); // Calorie controlled meals
                        }
                        
                        // Add vegetarian filter if needed
                        if (selectedData.foodType === 'vegetarian') {
                            query = query.eq('is_vegetarian', true);
                        }
                        
                        // Add healthy filter if needed
                        if (selectedData.foodType === 'healthy') {
                            query = query.eq('is_healthy', true);
                        }
                        
                        const { data: mealData, error } = await query.limit(10);
                        
                        if (!error && mealData && mealData.length > 0) {
                            // Pick random meal from results
                            const randomMeal = mealData[Math.floor(Math.random() * mealData.length)];
                            meals.push({
                                meal: getMealDisplayName(mealType),
                                food: randomMeal.food_name,
                                calories: randomMeal.calories,
                                protein: randomMeal.protein,
                                carbs: randomMeal.carbs,
                                fat: randomMeal.fat,
                                price_range: randomMeal.price_range,
                                ingredients: randomMeal.ingredients
                            });
                        } else {
                            // Fallback to any meal if no specific match
                            const { data: fallbackData } = await supabaseClient
                                .from('meals_database')
                                .select('*')
                                .limit(50);
                            
                            if (fallbackData && fallbackData.length > 0) {
                                const randomMeal = fallbackData[Math.floor(Math.random() * fallbackData.length)];
                                meals.push({
                                    meal: getMealDisplayName(mealType),
                                    food: randomMeal.food_name,
                                    calories: randomMeal.calories,
                                    protein: randomMeal.protein,
                                    carbs: randomMeal.carbs,
                                    fat: randomMeal.fat,
                                    price_range: randomMeal.price_range,
                                    ingredients: randomMeal.ingredients
                                });
                            }
                        }
                    }
                }
                
                // If no database connection or no meals found, use fallback
                if (meals.length === 0) {
                    meals = generateFallbackMeals();
                }
                
            } catch (error) {
                console.error('Database query error:', error);
                meals = generateFallbackMeals();
            }
            
            // Calculate total calories and generate HTML
            const mealEmojis = {
                "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤": "ü•£",
                "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô": "üç≤", 
                "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô": "ü•ó",
                "‡∏î‡∏∑‡πà‡∏°": "üßã",
                "‡∏Ç‡∏ô‡∏°": "üçø"
            };
            
            let planHtml = '';
            meals.forEach(meal => {
                totalCalories += meal.calories;
                planHtml += `
                    <div class="meal-card bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border-l-4" style="border-left-color: #cc1e0f;">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${mealEmojis[meal.meal]}</span>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${meal.meal}: ${meal.food}</div>
                                <div class="text-sm text-gray-600">${meal.calories} kcal</div>
                                ${meal.protein ? `<div class="text-xs text-gray-500 mt-1">
                                    ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ${meal.protein}g | ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö ${meal.carbs}g | ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô ${meal.fat}g
                                </div>` : ''}
                                ${meal.price_range ? `<div class="text-xs text-green-600 mt-1">üí∞ ${meal.price_range} ‡∏ö‡∏≤‡∏ó</div>` : ''}
                            </div>
                        </div>
                        ${meal.ingredients ? `<div class="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                            ü•ò ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°: ${meal.ingredients}
                        </div>` : ''}
                    </div>
                `;
            });

            document.getElementById('meal-plan-content').innerHTML = planHtml;
            
            const targetCalories = 1300;
            const prefText = {
                'high-protein': '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á',
                'low-carb': '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥',
                'calorie-control': '‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ',
                'just-delicious': '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            };

            const foodTypeText = {
                'thai': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',
                'western': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á',
                'noodles': '‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß',
                'healthy': '‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                'vegetarian': '‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à',
                'drinks': '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°',
                'snacks': '‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô'
            };

            document.getElementById('summary').innerHTML = `
                <div class="text-base font-semibold mb-2">
                    ‚úÖ ‡∏£‡∏ß‡∏° ${totalCalories} kcal / ‡πÄ‡∏õ‡πâ‡∏≤ ${targetCalories} kcal
                </div>
                <div class="text-gray-600 text-sm">
                    üí¨ ‡πÅ‡∏ô‡∏ß: ${foodTypeText[selectedData.foodType]} / ${prefText[selectedData.preference]}
                </div>
            `;

            // Generate tips
            generateTips();

            // Store generated plan
            const planData = {
                meals: meals,
                totalCalories: totalCalories,
                targetCalories: targetCalories,
                foodType: selectedData.foodType,
                preference: selectedData.preference
            };
            
            document.getElementById("generatedPlan").value = JSON.stringify(planData);
            
            // Save meal plan to database
            await saveMealPlan(planData);
            
            // Load and display data from database
            await loadMealPlanFromDatabase();
        }

        function getMealDisplayName(mealType) {
            const displayNames = {
                'breakfast': '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤',
                'lunch': '‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', 
                'dinner': '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô'
            };
            return displayNames[mealType] || '‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        }

        function generateFallbackMeals() {
            const fallbackMeals = {
                thai: {
                    breakfast: [
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡πÇ‡∏à‡πä‡∏Å‡∏´‡∏°‡∏π + ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°", calories: 320 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏°‡∏õ‡∏•‡∏≤", calories: 280 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏™‡∏±‡∏á‡∏Ç‡∏¢‡∏≤ + ‡∏Å‡∏≤‡πÅ‡∏ü", calories: 300 }
                    ],
                    lunch: [
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∏‡πâ‡∏á", calories: 450 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö + ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", calories: 480 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà", calories: 420 }
                    ],
                    dinner: [
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á + ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢", calories: 380 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡πÅ‡∏Å‡∏á‡∏à‡∏∑‡∏î‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ + ‡∏Ç‡πâ‡∏≤‡∏ß", calories: 350 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á‡πÑ‡∏ü‡πÅ‡∏î‡∏á + ‡∏Ç‡πâ‡∏≤‡∏ß", calories: 320 }
                    ]
                },
                western: {
                    breakfast: [
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á + ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", calories: 300 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏• + ‡∏ô‡∏°", calories: 320 }
                    ],
                    lunch: [
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡πÅ‡∏Æ‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå + ‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢", calories: 520 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤‡∏ä‡∏µ‡∏™", calories: 450 }
                    ],
                    dinner: [
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡∏ã‡∏µ‡∏ã‡∏≤‡∏£‡πå‡∏™‡∏•‡∏±‡∏î", calories: 380 },
                        { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á + ‡∏Ç‡πâ‡∏≤‡∏ß", calories: 400 }
                    ]
                }
            };

            const plan = fallbackMeals[selectedData.foodType] || fallbackMeals.thai;
            let meals = [];
            
            selectedData.meals.forEach(mealType => {
                const mealOptions = plan[mealType] || plan.lunch;
                const randomIndex = Math.floor(Math.random() * mealOptions.length);
                meals.push(mealOptions[randomIndex]);
            });
            
            return meals;
        }

        function regeneratePlan() {
            // Add loading animation
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà...';
            button.disabled = true;
            
            // Generate new plan after short delay for better UX
            setTimeout(() => {
                generateMealPlan();
                button.innerHTML = originalText;
                button.disabled = false;
                
                // Add success animation
                const mealPlanContent = document.getElementById('meal-plan-content');
                mealPlanContent.style.opacity = '0';
                setTimeout(() => {
                    mealPlanContent.style.opacity = '1';
                    mealPlanContent.style.transition = 'opacity 0.5s ease-in';
                }, 100);
            }, 1000);
        }

        function goBackToStart() {
            // Reset all data
            selectedData = {
                foodType: '',
                meals: [],
                preference: '',
                lineId: selectedData.lineId // Keep LINE ID
            };
            
            // Reset form
            document.getElementById("foodType").value = '';
            document.getElementById("mealCount").value = '';
            document.getElementById("preference").value = '';
            document.getElementById("generatedPlan").value = '';
            
            // Hide all steps except step 1
            for (let i = 2; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            document.getElementById('step1').classList.remove('hidden');
            
            // Reset step indicators
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                indicator.classList.remove('step-active', 'step-completed');
                if (i === 1) {
                    indicator.classList.add('step-active');
                } else {
                    indicator.classList.add('bg-white/30', 'text-white');
                }
            }
            
            // Reset current step
            currentStep = 1;
            
            // Remove any selection highlights
            document.querySelectorAll('.food-type-btn, .meal-btn, .pref-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-yellow-300');
            });
            
            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function generateTips() {
            const tips = {
                thai: [
                    "üå∂Ô∏è ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢‡∏ô‡∏∞ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ä‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î",
                    "ü•¨ ‡∏Ç‡∏≠‡∏ú‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ô‡∏∞ ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°",
                    "üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏¥‡∏ô",
                    "üßÑ ‡∏Ç‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç"
                ],
                western: [
                    "üçü ‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏Å‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÅ‡∏Ñ‡∏•",
                    "ü•§ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤",
                    "üßÄ ‡∏Ç‡∏≠‡∏ä‡∏µ‡∏™‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏ô",
                    "ü•ó ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‡∏™‡∏µ‡∏™‡∏±‡∏ô‡∏™‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢"
                ],
                noodles: [
                    "üçú ‡∏ô‡πâ‡∏≥‡∏ã‡∏∏‡∏õ‡∏î‡∏∑‡πà‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ä‡∏≤‡∏°‡∏û‡∏≠ ‡πÄ‡∏Ñ‡πá‡∏°‡πÄ‡∏Å‡∏¥‡∏ô",
                    "ü•© ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ 10-20 ‡∏ö‡∏≤‡∏ó ‡∏Ñ‡∏∏‡πâ‡∏°‡∏°‡∏≤‡∏Å",
                    "üåø ‡∏Ç‡∏≠‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡∏ô",
                    "ü•Ñ ‡∏Å‡∏¥‡∏ô‡∏ä‡πâ‡∏≤‡πÜ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¥‡πà‡∏°‡πÄ‡∏£‡πá‡∏ß"
                ],
                healthy: [
                    "ü•ë ‡∏≠‡∏∞‡πÇ‡∏ß‡∏Ñ‡∏≤‡πÇ‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏î‡∏µ ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏¥‡πà‡∏°‡∏ô‡∏≤‡∏ô",
                    "ü•ú ‡πÇ‡∏£‡∏¢‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏î‡πâ‡∏ß‡∏¢",
                    "üçã ‡∏ö‡∏µ‡∏ö‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡πÄ‡∏´‡∏•‡πá‡∏Å",
                    "üíß ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô 1 ‡πÅ‡∏Å‡πâ‡∏ß ‡∏à‡∏∞‡∏≠‡∏¥‡πà‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô"
                ],
                vegetarian: [
                    "üå± ‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏ó‡∏≠‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏°",
                    "ü•ï ‡∏ú‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏Å‡∏™‡∏µ ‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö",
                    "üçÑ ‡πÄ‡∏´‡πá‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏™‡∏≠‡∏π‡∏°‡∏≤‡∏°‡∏¥ ‡∏´‡∏≠‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢",
                    "üåæ ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡∏≤‡∏ß ‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡∏≠‡∏∞"
                ],
                drinks: [
                    "üßä ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏∑‡∏î",
                    "üçØ ‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ô‡∏∞ ‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÑ‡∏î‡πâ",
                    "ü•õ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡∏°‡∏Ç‡πâ‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏°‡∏™‡∏î",
                    "üåø ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå ‡∏´‡∏≠‡∏°‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô"
                ],
                snacks: [
                    "ü•ú‡∏ñ‡∏±‡πà‡∏ß‡∏Ñ‡∏±‡πà‡∏ß‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏≠‡∏î ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤",
                    "üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏´‡πâ‡∏á ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤",
                    "üçø ‡∏õ‡πä‡∏≠‡∏õ‡∏Ñ‡∏≠‡∏£‡πå‡∏ô‡∏£‡∏™‡∏à‡∏∑‡∏î ‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ‡∏ï‡πà‡∏≠‡πÉ‡∏à",
                    "üßä ‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô ‡∏´‡∏ß‡∏≤‡∏ô‡∏û‡∏≠‡∏î‡∏µ"
                ]
            };

            const generalTips = [
                "‚è∞ ‡∏Å‡∏¥‡∏ô‡∏ä‡πâ‡∏≤‡πÜ ‡∏™‡∏°‡∏≠‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏≠‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß",
                "üì± ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì",
                "üö∂‚Äç‚ôÄÔ∏è ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏¥‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢",
                "üòä ‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤"
            ];

            const foodTypeTips = tips[selectedData.foodType] || tips.thai;
            const randomFoodTip = foodTypeTips[Math.floor(Math.random() * foodTypeTips.length)];
            const randomGeneralTip = generalTips[Math.floor(Math.random() * generalTips.length)];

            document.getElementById('tips-content').innerHTML = `
                <div class="flex items-start space-x-2">
                    <span class="text-orange-500">‚Ä¢</span>
                    <span>${randomFoodTip}</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-orange-500">‚Ä¢</span>
                    <span>${randomGeneralTip}</span>
                </div>
            `;
        }

        async function saveMealPlan(planData) {
            try {
                // Create meal_plans table record
                const mealPlanRecord = {
                    line_id: selectedData.lineId,
                    food_type: selectedData.foodType,
                    meal_count: selectedData.meals.length,
                    selected_meals: selectedData.meals.join(','),
                    preference: selectedData.preference,
                    generated_plan: JSON.stringify(planData),
                    total_calories: planData.totalCalories,
                    created_at: new Date().toISOString()
                };
                
                console.log("Saving meal plan to database:", mealPlanRecord);
                
                if (supabaseClient) {
                    try {
                        // Save to meal_plans table
                        const { data: mealPlanData, error: mealPlanError } = await supabaseClient
                            .from('meal_plans')
                            .insert([mealPlanRecord])
                            .select()
                            .single();
                        
                        if (mealPlanError) {
                            console.error('Error saving meal plan:', mealPlanError);
                        } else {
                            console.log('Meal plan saved successfully:', mealPlanData);
                            
                            // Save individual meal selections to user_meal_selections table
                            if (mealPlanData && mealPlanData.id) {
                                const mealSelections = planData.meals.map(meal => ({
                                    meal_plan_id: mealPlanData.id,
                                    line_id: selectedData.lineId,
                                    food_name: meal.food,
                                    meal_time: getMealTimeFromDisplay(meal.meal),
                                    calories: meal.calories,
                                    protein: meal.protein || null,
                                    carbs: meal.carbs || null,
                                    fat: meal.fat || null,
                                    price_range: meal.price_range || null,
                                    created_at: new Date().toISOString()
                                }));
                                
                                const { error: selectionsError } = await supabaseClient
                                    .from('user_meal_selections')
                                    .insert(mealSelections);
                                
                                if (selectionsError) {
                                    console.error('Error saving meal selections:', selectionsError);
                                } else {
                                    console.log('Meal selections saved successfully');
                                }
                            }
                        }
                    } catch (dbError) {
                        console.error('Database connection error:', dbError);
                    }
                } else {
                    console.log("Demo mode - data would be saved:", mealPlanRecord);
                }
            } catch (error) {
                console.error('Error in saveMealPlan:', error);
            }
        }

        function getMealTimeFromDisplay(displayName) {
            const timeMap = {
                '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤': 'breakfast',
                '‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô': 'lunch',
                '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô': 'dinner'
            };
            return timeMap[displayName] || 'lunch';
        }

        async function loadMealPlanFromDatabase() {
            try {
                // Show loading state
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('meal-plan-content').classList.add('hidden');
                document.getElementById('summary-section').classList.add('hidden');
                document.getElementById('user-history').classList.add('hidden');
                document.getElementById('tips-section').classList.add('hidden');
                document.getElementById('action-buttons').classList.add('hidden');

                // Always show the generated plan after a short delay
                setTimeout(() => {
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('meal-plan-content').classList.remove('hidden');
                    document.getElementById('summary-section').classList.remove('hidden');
                    document.getElementById('tips-section').classList.remove('hidden');
                    document.getElementById('action-buttons').classList.remove('hidden');
                    generateTips();
                }, 1500);

                // Try to load from database in background (optional)
                if (supabaseClient) {
                    try {
                        // Load user preferences history
                        const { data: historyData, error: historyError } = await supabaseClient
                            .from('user_preferences')
                            .select('*')
                            .eq('line_id', selectedData.lineId)
                            .order('created_at', { ascending: false })
                            .limit(5);

                        if (!historyError && historyData && historyData.length > 0) {
                            setTimeout(() => {
                                displayUserHistory(historyData);
                            }, 2000);
                        }
                    } catch (dbError) {
                        console.error('Database error (non-blocking):', dbError);
                        // Continue without database features
                    }
                }

            } catch (error) {
                console.error('Error loading from database:', error);
                // Always fallback to showing generated plan
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('meal-plan-content').classList.remove('hidden');
                document.getElementById('summary-section').classList.remove('hidden');
                document.getElementById('tips-section').classList.remove('hidden');
                document.getElementById('action-buttons').classList.remove('hidden');
                generateTips();
            }
        }

        function displayMealPlanFromDatabase(planData, dbRecord) {
            const mealEmojis = {
                "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤": "ü•£",
                "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô": "üç≤",
                "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô": "ü•ó",
                "‡∏î‡∏∑‡πà‡∏°": "üßã",
                "‡∏Ç‡∏ô‡∏°": "üçø"
            };

            let planHtml = '';
            planData.meals.forEach(meal => {
                planHtml += `
                    <div class="meal-card bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border-l-4" style="border-left-color: #cc1e0f;">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${mealEmojis[meal.meal]}</span>
                            <div>
                                <div class="font-semibold text-gray-800">${meal.meal}: ${meal.food}</div>
                                <div class="text-sm text-gray-600">(${meal.calories} kcal)</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('meal-plan-content').innerHTML = planHtml;

            const foodTypeText = {
                'thai': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',
                'western': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á',
                'noodles': '‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß',
                'healthy': '‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                'vegetarian': '‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à',
                'drinks': '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°',
                'snacks': '‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô'
            };

            const prefText = {
                'high-protein': '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á',
                'low-carb': '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥',
                'calorie-control': '‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ',
                'just-delicious': '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            };

            document.getElementById('summary').innerHTML = `
                <div class="text-base font-semibold mb-2">
                    ‚úÖ ‡∏£‡∏ß‡∏° ${dbRecord.total_calories} kcal / ‡πÄ‡∏õ‡πâ‡∏≤ ${planData.targetCalories} kcal
                </div>
                <div class="text-gray-600 text-sm">
                    üí¨ ‡πÅ‡∏ô‡∏ß: ${foodTypeText[dbRecord.food_type]} / ${prefText[dbRecord.preference]}
                </div>
                <div class="text-gray-500 text-xs mt-2">
                    üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(dbRecord.created_at).toLocaleString('th-TH')}
                </div>
            `;

            // Show all sections
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('meal-plan-content').classList.remove('hidden');
            document.getElementById('summary-section').classList.remove('hidden');
            document.getElementById('tips-section').classList.remove('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');
            
            generateTips();
        }

        function displayUserHistory(historyData) {
            if (!historyData || historyData.length === 0) return;

            const foodTypeText = {
                'thai': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',
                'western': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á',
                'noodles': '‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß',
                'healthy': '‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                'vegetarian': '‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à',
                'drinks': '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°',
                'snacks': '‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô'
            };

            const prefText = {
                'high-protein': '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á',
                'low-carb': '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥',
                'calorie-control': '‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ',
                'just-delicious': '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            };

            let historyHtml = '';
            historyData.slice(0, 3).forEach((record, index) => {
                const date = new Date(record.created_at).toLocaleDateString('th-TH');
                historyHtml += `
                    <div class="flex items-center justify-between py-2 ${index < historyData.length - 1 ? 'border-b border-blue-200' : ''}">
                        <div class="text-sm">
                            <span class="font-medium">${foodTypeText[record.food_type]}</span> - 
                            <span class="text-blue-600">${prefText[record.preference]}</span>
                        </div>
                        <div class="text-xs text-blue-500">${date}</div>
                    </div>
                `;
            });

            document.getElementById('history-content').innerHTML = historyHtml;
            document.getElementById('user-history').classList.remove('hidden');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d78621a058d02e',t:'MTc1NDkxMzExNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
