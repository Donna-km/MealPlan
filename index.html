<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .bg-primary { background-color: #cc1e0f; }
        .border-accent { border-color: #e9e2d0; }
        .text-accent { color: #e9e2d0; }
        .hover-accent:hover { background-color: #e9e2d0; color: #cc1e0f; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-glow { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(233, 226, 208, 0.3); }
            50% { box-shadow: 0 0 30px rgba(233, 226, 208, 0.6); }
        }
    </style>
</head>
<body class="bg-primary min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8 slide-in">
            <h1 class="text-3xl font-bold text-accent mb-2">ü§î ‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å</h1>
            <h2 class="text-2xl font-semibold mb-4">‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏• ‚ú®</h2>
            <p class="text-lg opacity-90">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏≠‡∏á!</p>
        </div>

        <!-- Step 1: Food Type Selection -->
        <div id="step1" class="slide-in">
            <div class="bg-white rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-xl font-semibold mb-4 text-center text-amber-900">üçΩÔ∏è ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡πÑ‡∏´‡∏ô‡∏î‡∏µ?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="selectFoodType('thai')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">üáπüá≠</div>
                        <div class="font-medium">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</div>
                    </button>
                    <button onclick="selectFoodType('western')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">üçù</div>
                        <div class="font-medium">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á</div>
                    </button>
                    <button onclick="selectFoodType('noodle')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">üçú</div>
                        <div class="font-medium">‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</div>
                    </button>
                    <button onclick="selectFoodType('healthy')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">ü•ó</div>
                        <div class="font-medium">‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                    </button>
                    <button onclick="selectFoodType('vegan')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">üßò</div>
                        <div class="font-medium">‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à</div>
                    </button>
                    <button onclick="selectFoodType('snack')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">üçø</div>
                        <div class="font-medium">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</div>
                    </button>
                    <button onclick="selectFoodType('drinks')" class="food-type-btn text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <div class="text-2xl mb-2">üßã</div>
                        <div class="font-medium">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Meal Selection -->
        <div id="step2" class="hidden slide-in">
            <div class="bg-white rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-xl font-semibold mb-2 text-center text-amber-900">üßÆ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á?</h3>
                <p class="text-center text-sm text-amber-700 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏∞</p>
                <div class="space-y-3">
                    <button onclick="toggleMeal('breakfast')" id="breakfast-btn" class="meal-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üåÖ</span>
                        <span class="font-medium">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</span>
                        <span class="ml-auto text-xl hidden" id="breakfast-check">‚úÖ</span>
                    </button>
                    <button onclick="toggleMeal('lunch')" id="lunch-btn" class="meal-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">‚òÄÔ∏è</span>
                        <span class="font-medium">‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</span>
                        <span class="ml-auto text-xl hidden" id="lunch-check">‚úÖ</span>
                    </button>
                    <button onclick="toggleMeal('dinner')" id="dinner-btn" class="meal-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üåô</span>
                        <span class="font-medium">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô</span>
                        <span class="ml-auto text-xl hidden" id="dinner-check">‚úÖ</span>
                    </button>
                </div>
                <button onclick="proceedToStep3()" id="continue-btn" class="w-full mt-4 text-white font-semibold rounded-xl p-4 transition-all duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed" style="background-color: #DDB4A5;" disabled>
                    ‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚û°Ô∏è
                </button>
            </div>
        </div>

        <!-- Step 3: Focus Selection -->
        <div id="step3" class="hidden slide-in">
            <div class="bg-white rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-xl font-semibold mb-2 text-center text-amber-900">üí™ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏´‡∏°</h3>
                <p class="text-center text-sm text-amber-700 mb-4">‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô ‡πÜ</p>
                <div class="space-y-3">
                    <button onclick="selectFocus('protein')" class="focus-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">ü•©</span>
                        <span class="font-medium">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á</span>
                    </button>
                    <button onclick="selectFocus('lowcarb')" class="focus-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üßò‚Äç‚ôÄÔ∏è</span>
                        <span class="font-medium">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥</span>
                    </button>
                    <button onclick="selectFocus('lowcal')" class="focus-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üíß</span>
                        <span class="font-medium">‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ</span>
                    </button>
                    <button onclick="selectFocus('tasty')" class="focus-btn w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üß°</span>
                        <span class="font-medium">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-8">
            <div class="pulse-glow bg-white/20 rounded-2xl p-8 border-2 border-accent">
                <div class="text-4xl mb-4">ü§ñ</div>
                <h3 class="text-xl font-semibold mb-2">‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ...</h3>
                <p class="opacity-80">‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡∏µ ‡πÜ ‡πÉ‡∏´‡πâ ‚ú®</p>
                <div class="mt-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent mx-auto"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden slide-in">
            <div class="bg-white rounded-2xl p-6 mb-6">
                <h3 class="text-2xl font-bold text-center mb-4 text-amber-900">üç± Meal Plan ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</h3>
                <div id="mealPlan" class="space-y-4 mb-6">
                    <!-- Meals will be populated here -->
                </div>
                <div id="summary" class="bg-amber-50 rounded-xl p-4 mb-4">
                    <!-- Summary will be populated here -->
                </div>
                <div id="tip" class="bg-amber-100 rounded-xl p-4 mb-4">
                    <h4 class="font-semibold mb-2 text-amber-900">üí° ‡∏ó‡∏£‡∏¥‡∏õ!! ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•:</h4>
                    <p id="tipText" class="text-sm text-amber-800"></p>
                </div>
                <div class="space-y-3">
                    <button onclick="changeMenuType()" class="w-full text-white hover:opacity-80 border-2 rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üîÑ</span>
                        <span class="font-medium">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                    <button onclick="goToHome()" class="w-full text-white font-semibold rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center hover:opacity-80 border-2" style="background-color: #DDB4A5; border-color: #DDB4A5;">
                        <span class="text-2xl mr-3">üè†</span>
                        <span class="font-medium">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden form for LINE ID -->
        <input type="hidden" id="lineId" name="lineId">
    </div>

    <script>
        // App state
        let appState = {
            foodType: '',
            selectedMeals: [],
            focus: '',
            lineUserId: '',
            goalCalories: 1300
        };

        // Initialize Supabase with fallback
        const supabaseUrl = 'https://lvtdqeerzxpznnayccmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
        let supabase = null;
        
        // Only initialize if credentials are provided
        if (supabaseUrl !== 'YOUR_SUPABASE_URL' && supabaseKey !== 'YOUR_SUPABASE_ANON_KEY') {
            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            } catch (error) {
                console.log('Supabase initialization failed:', error);
                supabase = null;
            }
        }

        // Get meals from Supabase with fallback data
        async function getMealsFromSupabase(foodType, mealTimes, focus) {
            // Fallback data if Supabase is not connected
            const fallbackMealsData = {
                thai: [
                    { food_name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢', meal_time: 'breakfast', calories: 320, protein: 15, carbs: 45, fat: 8, tip: '‡∏Å‡∏¥‡∏ô‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏î‡∏µ ‡πÜ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô!' },
                    { food_name: '‡πÇ‡∏à‡πä‡∏Å‡∏´‡∏°‡∏π', meal_time: 'breakfast', calories: 280, protein: 12, carbs: 40, fat: 6, tip: '‡πÇ‡∏à‡πä‡∏Å‡∏´‡∏°‡∏π‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤' },
                    { food_name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤', meal_time: 'breakfast', calories: 420, protein: 18, carbs: 55, fat: 12, tip: '‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏° ‡πÜ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏ô!' },
                    { food_name: '‡∏•‡∏≤‡∏ö‡∏≠‡∏Å‡πÑ‡∏Å‡πà', meal_time: 'lunch', calories: 450, protein: 35, carbs: 25, fat: 12, tip: '‡∏•‡∏≤‡∏ö‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢' },
                    { food_name: '‡∏™‡πâ‡∏°‡∏ï‡∏≥‡πÑ‡∏ó‡∏¢', meal_time: 'lunch', calories: 180, protein: 8, carbs: 25, fat: 5, tip: '‡∏™‡πâ‡∏°‡∏ï‡∏≥‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ã‡∏µ ‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô‡∏î‡∏µ' },
                    { food_name: '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏Å‡πà', meal_time: 'lunch', calories: 380, protein: 25, carbs: 20, fat: 22, tip: '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ ‡πÜ' },
                    { food_name: '‡πÅ‡∏Å‡∏á‡∏à‡∏∑‡∏î‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', meal_time: 'dinner', calories: 380, protein: 28, carbs: 15, fat: 18, tip: '‡πÅ‡∏Å‡∏á‡∏à‡∏∑‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô' },
                    { food_name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°‡∏ô‡∏∂‡πà‡∏á‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', meal_time: 'dinner', calories: 250, protein: 30, carbs: 8, fat: 10, tip: '‡∏õ‡∏•‡∏≤‡∏ô‡∏∂‡πà‡∏á‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÄ‡∏ö‡∏≤ ‡πÜ ‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                    { food_name: '‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏•‡∏∑‡∏≠', meal_time: 'dinner', calories: 320, protein: 35, carbs: 5, fat: 15, tip: '‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥' }
                ],
                western: [
                    { food_name: 'Scrambled Eggs Toast', meal_time: 'breakfast', calories: 350, protein: 18, carbs: 30, fat: 15, tip: '‡πÑ‡∏Ç‡πà‡∏Å‡∏ß‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô' },
                    { food_name: 'Pancakes with Berries', meal_time: 'breakfast', calories: 380, protein: 12, carbs: 55, fat: 12, tip: '‡πÅ‡∏û‡∏ô‡πÄ‡∏Ñ‡πâ‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà‡∏´‡∏ß‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç' },
                    { food_name: 'Avocado Toast', meal_time: 'breakfast', calories: 320, protein: 8, carbs: 35, fat: 18, tip: '‡∏≠‡∏∞‡πÇ‡∏ß‡∏Ñ‡∏≤‡πÇ‡∏î‡πÇ‡∏ó‡∏™‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏î‡∏µ ‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                    { food_name: 'Grilled Chicken Salad', meal_time: 'lunch', calories: 420, protein: 40, carbs: 20, fat: 10, tip: '‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô' },
                    { food_name: 'Caesar Salad', meal_time: 'lunch', calories: 380, protein: 15, carbs: 25, fat: 25, tip: '‡∏ã‡∏µ‡∏ã‡∏≤‡∏£‡πå‡∏™‡∏•‡∏±‡∏î‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Å ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô' },
                    { food_name: 'Chicken Wrap', meal_time: 'lunch', calories: 450, protein: 30, carbs: 40, fat: 18, tip: '‡πÑ‡∏Å‡πà‡πÅ‡∏£‡πá‡∏õ‡∏û‡∏Å‡∏û‡∏≤‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏≠‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≠‡∏á‡∏î‡∏µ' },
                    { food_name: 'Salmon Steak', meal_time: 'dinner', calories: 480, protein: 35, carbs: 10, fat: 25, tip: '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô‡∏°‡∏µ‡πÇ‡∏≠‡πÄ‡∏°‡∏Å‡πâ‡∏≤ 3 ‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à' },
                    { food_name: 'Grilled Beef Steak', meal_time: 'dinner', calories: 520, protein: 45, carbs: 8, fat: 30, tip: '‡∏™‡πÄ‡∏ï‡πá‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢' },
                    { food_name: 'Baked Chicken Breast', meal_time: 'dinner', calories: 280, protein: 35, carbs: 5, fat: 12, tip: '‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏≠‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥' }
                ],
                healthy: [
                    { food_name: 'Quinoa Bowl', meal_time: 'breakfast', calories: 300, protein: 12, carbs: 40, fat: 8, tip: '‡∏Ñ‡∏ß‡∏¥‡∏ô‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ü‡∏π‡πâ‡∏î ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' },
                    { food_name: 'Buddha Bowl', meal_time: 'lunch', calories: 380, protein: 15, carbs: 45, fat: 12, tip: 'Buddha Bowl ‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà' },
                    { food_name: 'Steamed Fish', meal_time: 'dinner', calories: 320, protein: 30, carbs: 5, fat: 15, tip: '‡∏õ‡∏•‡∏≤‡∏ô‡∏∂‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô' }
                ],
                noodle: [
                    { food_name: '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏°‡∏¢‡∏≥', meal_time: 'breakfast', calories: 380, protein: 20, carbs: 50, fat: 10, tip: '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏î‡∏µ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏ô!' },
                    { food_name: '‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏Å‡∏∏‡πâ‡∏á‡∏™‡∏î', meal_time: 'lunch', calories: 450, protein: 25, carbs: 55, fat: 15, tip: '‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' },
                    { food_name: '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠', meal_time: 'dinner', calories: 420, protein: 30, carbs: 45, fat: 12, tip: '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ ‡∏≠‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≠‡∏á‡∏î‡∏µ' }
                ],
                vegan: [
                    { food_name: '‡πÇ‡∏à‡πä‡∏Å‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', meal_time: 'breakfast', calories: 250, protein: 8, carbs: 45, fat: 3, tip: '‡πÇ‡∏à‡πä‡∏Å‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤' },
                    { food_name: '‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ', meal_time: 'lunch', calories: 320, protein: 15, carbs: 25, fat: 18, tip: '‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö ‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô' },
                    { food_name: '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏à', meal_time: 'dinner', calories: 280, protein: 12, carbs: 20, fat: 15, tip: '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏à‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏û‡πâ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' }
                ],
                snack: [
                    { food_name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏ö‡∏õ‡∏•‡∏≤', meal_time: 'breakfast', calories: 150, protein: 5, carbs: 25, fat: 4, tip: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏ö‡∏õ‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏ô‡∏°‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏î‡∏µ' },
                    { food_name: '‡∏ñ‡∏±‡πà‡∏ß‡∏•‡∏¥‡∏™‡∏á‡∏Ñ‡∏±‡πà‡∏ß', meal_time: 'lunch', calories: 180, protein: 8, carbs: 12, fat: 12, tip: '‡∏ñ‡∏±‡πà‡∏ß‡∏•‡∏¥‡∏™‡∏á‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏ô‡∏°‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô' },
                    { food_name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏≠‡∏ö', meal_time: 'dinner', calories: 120, protein: 2, carbs: 28, fat: 1, tip: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢' }
                ],
                drinks: [
                    { food_name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡∏õ‡∏±‡πà‡∏ô', meal_time: 'breakfast', calories: 120, protein: 2, carbs: 30, fat: 0, tip: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ã‡∏µ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô!' },
                    { food_name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', meal_time: 'lunch', calories: 80, protein: 0, carbs: 20, fat: 0, tip: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏µ‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≤‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                    { food_name: '‡∏ô‡∏°‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå', meal_time: 'dinner', calories: 60, protein: 3, carbs: 8, fat: 3, tip: '‡∏ô‡∏°‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏•‡∏Ñ‡πÇ‡∏ï‡∏™ ‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô' }
                ]
            };

            // If Supabase is not connected, use fallback data
            if (!supabase) {
                console.log('Using fallback meal data');
                return fallbackMealsData[foodType] || fallbackMealsData.thai;
            }

            try {
                // Build query based on parameters
                let query = supabase
                    .from('meals_database')
                    .select('*')
                    .eq('food_type', foodType);

                // Add meal time filter if specified
                if (mealTimes && mealTimes.length > 0) {
                    query = query.in('meal_time', mealTimes);
                }

                // Add focus filter if specified
                if (focus && focus !== 'tasty') {
                    switch (focus) {
                        case 'protein':
                            query = query.gte('protein', 20);
                            break;
                        case 'lowcarb':
                            query = query.lte('carbs', 30);
                            break;
                        case 'lowcal':
                            query = query.lte('calories', 400);
                            break;
                    }
                }

                const { data, error } = await query.limit(10);

                if (error) {
                    console.error('Error fetching meals:', error);
                    return fallbackMealsData[foodType] || fallbackMealsData.thai;
                }

                if (data && data.length > 0) {
                    return data;
                }

                // If no data found, return fallback
                return fallbackMealsData[foodType] || fallbackMealsData.thai;

            } catch (error) {
                console.error('Supabase query error:', error);
                return fallbackMealsData[foodType] || fallbackMealsData.thai;
            }
        }

        // Get goal calories from Supabase with timeout
        async function getGoalCalories(userId) {
            // If Supabase is not connected, return default immediately
            if (!supabase) {
                console.log('Supabase not connected, using default goal calories');
                return 1300;
            }

            try {
                // Add timeout to prevent long loading
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), 3000)
                );

                const supabasePromise = supabase
                    .from('tdee_form')
                    .select('goal_calories')
                    .eq('line_user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(1);

                const { data, error } = await Promise.race([supabasePromise, timeoutPromise]);

                if (error) {
                    console.error('Error fetching goal calories:', error);
                    return 1300; // Default value
                }

                if (data && data.length > 0) {
                    return data[0].goal_calories || 1300;
                }
                
                return 1300; // Default if no data found
            } catch (error) {
                console.error('Supabase connection error or timeout:', error);
                return 1300; // Return default immediately on error
            }
        }

        // Initialize LIFF
        async function initializeLIFF() {
            try {
                // Replace with your actual LIFF ID
                await liff.init({ liffId: "2007859046-yEGnq0GX" });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                appState.lineUserId = profile.userId;
                document.getElementById("lineId").value = profile.userId;
                
                // Get goal calories from database
                appState.goalCalories = await getGoalCalories(profile.userId);
            } catch (error) {
                console.log("LIFF initialization failed:", error);
                // For demo purposes, use a mock user ID
                appState.lineUserId = "demo_user_" + Date.now();
                appState.goalCalories = 1300; // Default for demo
            }
        }

        // Step functions
        function selectFoodType(type) {
            appState.foodType = type;
            showStep('step2');
        }

        function toggleMeal(mealType) {
            const index = appState.selectedMeals.indexOf(mealType);
            const btn = document.getElementById(mealType + '-btn');
            const check = document.getElementById(mealType + '-check');
            
            if (index > -1) {
                // Remove meal
                appState.selectedMeals.splice(index, 1);
                btn.style.backgroundColor = '#DDB4A5';
                btn.style.borderColor = '#DDB4A5';
                btn.style.opacity = '1';
                check.classList.add('hidden');
            } else {
                // Add meal
                appState.selectedMeals.push(mealType);
                btn.style.backgroundColor = '#B8967D';
                btn.style.borderColor = '#B8967D';
                btn.style.opacity = '1';
                check.classList.remove('hidden');
            }
            
            // Update continue button
            const continueBtn = document.getElementById('continue-btn');
            if (appState.selectedMeals.length > 0) {
                continueBtn.disabled = false;
                continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.add('hover:scale-105');
            } else {
                continueBtn.disabled = true;
                continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.remove('hover:scale-105');
            }
        }

        function proceedToStep3() {
            if (appState.selectedMeals.length > 0) {
                showStep('step3');
            }
        }

        function selectFocus(focus) {
            appState.focus = focus;
            generateMealPlan();
        }

        function showStep(stepId) {
            // Hide all steps
            ['step1', 'step2', 'step3', 'loading', 'results'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Show target step
            document.getElementById(stepId).classList.remove('hidden');
        }

        // Store previously selected meals to avoid duplicates
        let previouslySelectedMeals = [];

        async function generateMealPlan() {
            showStep('loading');
            
            try {
                // Get meals from Supabase or fallback data
                const allMeals = await getMealsFromSupabase(appState.foodType, appState.selectedMeals, appState.focus);
                const selectedMeals = [];
                
                // Get meals for selected meal times - always randomize selection
                appState.selectedMeals.forEach(mealTime => {
                    // Filter meals for this specific meal time
                    let mealsForTime = allMeals.filter(meal => meal.meal_time === mealTime);
                    
                    // If we have previously selected meals, try to avoid them
                    if (previouslySelectedMeals.length > 0) {
                        const availableMeals = mealsForTime.filter(meal => 
                            !previouslySelectedMeals.some(prevMeal => 
                                prevMeal.food_name === meal.food_name && prevMeal.meal_time === meal.meal_time
                            )
                        );
                        
                        // Use available meals if we have them, otherwise use all meals
                        if (availableMeals.length > 0) {
                            mealsForTime = availableMeals;
                        }
                    }
                    
                    if (mealsForTime.length > 0) {
                        // Randomly select from meals for this time
                        const randomIndex = Math.floor(Math.random() * mealsForTime.length);
                        selectedMeals.push(mealsForTime[randomIndex]);
                    } else {
                        // If no specific meal found for this time, get a random one from all meals and adjust meal_time
                        let availableAllMeals = [...allMeals];
                        
                        // Try to avoid previously selected meals
                        if (previouslySelectedMeals.length > 0) {
                            const filteredMeals = allMeals.filter(meal => 
                                !previouslySelectedMeals.some(prevMeal => prevMeal.food_name === meal.food_name)
                            );
                            if (filteredMeals.length > 0) {
                                availableAllMeals = filteredMeals;
                            }
                        }
                        
                        const randomMeal = availableAllMeals[Math.floor(Math.random() * availableAllMeals.length)];
                        if (randomMeal) {
                            selectedMeals.push({
                                ...randomMeal,
                                meal_time: mealTime
                            });
                        }
                    }
                });
                
                // Store current selection for next time
                previouslySelectedMeals = [...selectedMeals];
                currentMealPlan = [...selectedMeals];
                
                // Add delay for better UX
                setTimeout(() => {
                    displayMealPlan(selectedMeals);
                    showStep('results');
                    
                    // Save to Supabase
                    saveMealPlan(selectedMeals);
                }, 1500);
                
            } catch (error) {
                console.error('Error generating meal plan:', error);
                // Fallback to basic meal plan
                setTimeout(() => {
                    const basicMeals = [
                        { food_name: '‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', meal_time: 'lunch', calories: 400, protein: 20, carbs: 40, fat: 15, tip: '‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' }
                    ];
                    displayMealPlan(basicMeals);
                    showStep('results');
                }, 1500);
            }
        }

        function displayMealPlan(meals) {
            const mealPlanDiv = document.getElementById('mealPlan');
            const summaryDiv = document.getElementById('summary');
            const tipDiv = document.getElementById('tipText');
            
            let totalCalories = 0;
            let totalProtein = 0;
            
            const mealEmojis = {
                breakfast: 'ü•£',
                lunch: 'üç≤',
                dinner: 'ü•ó'
            };
            
            const mealNames = {
                breakfast: '‡πÄ‡∏ä‡πâ‡∏≤',
                lunch: '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
                dinner: '‡πÄ‡∏¢‡πá‡∏ô'
            };
            
            mealPlanDiv.innerHTML = meals.map((meal) => {
                totalCalories += meal.calories;
                totalProtein += meal.protein;
                
                return `
                    <div class="bg-amber-50 rounded-xl p-4">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">${mealEmojis[meal.meal_time]}</span>
                            <span class="font-semibold text-amber-900">${mealNames[meal.meal_time]}:</span>
                        </div>
                        <div class="ml-8">
                            <div class="font-medium text-amber-900">${meal.food_name}</div>
                            <div class="text-sm text-amber-700">(${meal.calories} kcal)</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            summaryDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-semibold mb-2 text-amber-900">‚úÖ ‡∏£‡∏ß‡∏° ${totalCalories} kcal / ‡πÄ‡∏õ‡πâ‡∏≤ ${appState.goalCalories.toLocaleString()} kcal</div>
                    <div class="text-sm text-amber-700">üí¨ ‡πÅ‡∏ô‡∏ß: ${getFoodTypeName(appState.foodType)} / ${getFocusName(appState.focus)}</div>
                </div>
            `;
            
            // Random tip
            const randomTip = meals[Math.floor(Math.random() * meals.length)].tip;
            tipDiv.textContent = randomTip;
        }

        function getFoodTypeName(type) {
            const names = {
                thai: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',
                western: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á',
                noodle: '‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß',
                healthy: '‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                vegan: '‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à',
                snack: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô',
                drinks: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'
            };
            return names[type] || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢';
        }

        function getFocusName(focus) {
            const names = {
                protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á',
                lowcarb: '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥',
                lowcal: '‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ',
                tasty: '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            };
            return names[focus] || '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô';
        }

        async function saveMealPlan(meals) {
            // Mock Supabase save
            const planData = {
                line_user_id: appState.lineUserId,
                food_type: appState.foodType,
                selected_meals: appState.selectedMeals,
                focus: appState.focus,
                meals: meals,
                created_at: new Date().toISOString()
            };
            
            console.log('Saving meal plan:', planData);
            // In real implementation, save to Supabase here
        }

        // Global variable to track current meal plan
        let currentMealPlan = [];

        function changeMenuType() {
            // Force completely new meal plan generation
            showStep('loading');
            
            // Add a small delay to show loading animation
            setTimeout(async () => {
                try {
                    // Get fresh meals from database/fallback
                    const allMeals = await getMealsFromSupabase(appState.foodType, appState.selectedMeals, appState.focus);
                    const selectedMeals = [];
                    
                    // Create a shuffled copy of all meals to ensure randomness
                    const shuffledMeals = [...allMeals].sort(() => Math.random() - 0.5);
                    
                    appState.selectedMeals.forEach((mealTime, index) => {
                        // Filter meals for this specific meal time
                        let mealsForTime = shuffledMeals.filter(meal => meal.meal_time === mealTime);
                        
                        // If we have a current meal plan, exclude those meals
                        if (currentMealPlan.length > 0) {
                            mealsForTime = mealsForTime.filter(meal => 
                                !currentMealPlan.some(currentMeal => 
                                    currentMeal.food_name === meal.food_name
                                )
                            );
                        }
                        
                        // If no meals left after filtering, use all meals for this time
                        if (mealsForTime.length === 0) {
                            mealsForTime = shuffledMeals.filter(meal => meal.meal_time === mealTime);
                        }
                        
                        // If still no meals, use any meal and adjust meal_time
                        if (mealsForTime.length === 0) {
                            mealsForTime = [...shuffledMeals];
                        }
                        
                        if (mealsForTime.length > 0) {
                            // Pick the first meal from shuffled array (already randomized)
                            const selectedMeal = mealsForTime[0];
                            
                            selectedMeals.push({
                                ...selectedMeal,
                                meal_time: mealTime // Ensure correct meal time
                            });
                        }
                    });
                    
                    // Update current meal plan for next comparison
                    currentMealPlan = [...selectedMeals];
                    
                    displayMealPlan(selectedMeals);
                    showStep('results');
                    
                    // Save to Supabase
                    saveMealPlan(selectedMeals);
                } catch (error) {
                    console.error('Error changing menu:', error);
                    // Fallback - generate completely new plan with enhanced randomization
                    const fallbackMeals = [];
                    const basicMealData = {
                        thai: [
                            '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤', '‡∏™‡πâ‡∏°‡∏ï‡∏≥‡πÑ‡∏ó‡∏¢', '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô', '‡∏•‡∏≤‡∏ö‡∏´‡∏°‡∏π', '‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á',
                            '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á', '‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢', '‡∏°‡∏≤‡∏°‡πà‡∏≤‡∏ï‡πâ‡∏°‡∏¢‡∏≥', '‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà', '‡πÅ‡∏Å‡∏á‡∏™‡πâ‡∏°',
                            '‡∏õ‡∏•‡∏≤‡∏ó‡∏≠‡∏î', '‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á', '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', '‡πÅ‡∏Å‡∏á‡∏à‡∏∑‡∏î', '‡∏¢‡∏≥‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô'
                        ],
                        western: [
                            'Chicken Salad', 'Pasta Carbonara', 'Beef Steak', 'Club Sandwich', 'Margherita Pizza',
                            'Fish & Chips', 'Burger', 'Caesar Salad', 'Grilled Salmon', 'Chicken Wrap',
                            'Mushroom Risotto', 'BBQ Ribs', 'Chicken Wings', 'Tuna Sandwich', 'Beef Tacos'
                        ],
                        noodle: [
                            '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏°‡∏¢‡∏≥', '‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏Å‡∏∏‡πâ‡∏á‡∏™‡∏î', '‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á', '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠', '‡∏ú‡∏±‡∏î‡∏ã‡∏µ‡∏≠‡∏¥‡πä‡∏ß‡∏´‡∏°‡∏π',
                            '‡∏£‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏°‡∏π', '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡πÉ‡∏™', '‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏ô‡πâ‡∏≥', '‡∏ú‡∏±‡∏î‡∏Ç‡∏µ‡πâ‡πÄ‡∏°‡∏≤', '‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏ú‡∏±‡∏î‡∏ã‡∏µ‡∏≠‡∏¥‡πä‡∏ß',
                            '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏•‡∏π‡∏Å‡∏ä‡∏¥‡πâ‡∏ô', '‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á', '‡∏ú‡∏±‡∏î‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô', '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏´‡∏°‡∏π‡∏ï‡∏∏‡πã‡∏ô', '‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏°‡∏µ‡πà‡∏ú‡∏±‡∏î'
                        ],
                        healthy: [
                            'Quinoa Bowl', 'Green Salad', 'Steamed Fish', 'Grilled Chicken Breast', 'Vegetable Soup',
                            'Brown Rice Bowl', 'Tofu Salad', 'Steamed Vegetables', 'Baked Sweet Potato', 'Fruit Salad',
                            'Smoothie Bowl', 'Grilled Vegetables', 'Chicken Soup', 'Avocado Toast', 'Protein Bowl'
                        ],
                        vegan: [
                            '‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ', '‡πÇ‡∏à‡πä‡∏Å‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡πÅ‡∏Å‡∏á‡πÄ‡∏à', '‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏™‡∏î', '‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å',
                            '‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ', '‡∏ú‡∏±‡∏î‡∏ö‡∏∏‡πâ‡∏á‡πÑ‡∏ü‡πÅ‡∏î‡∏á', '‡πÅ‡∏Å‡∏á‡∏™‡πâ‡∏°‡∏ú‡∏±‡∏Å', '‡∏¢‡∏≥‡∏ñ‡∏±‡πà‡∏ß‡∏û‡∏•‡∏π', '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å',
                            '‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡∏ú‡∏±‡∏Å', '‡πÅ‡∏Å‡∏á‡πÄ‡∏•‡∏µ‡∏¢‡∏á‡∏ú‡∏±‡∏Å', '‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á', '‡∏ï‡πâ‡∏°‡∏Ç‡πà‡∏≤‡πÄ‡∏´‡πá‡∏î', '‡∏¢‡∏≥‡∏ú‡∏±‡∏Å‡∏™‡∏î'
                        ],
                        snack: [
                            '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á', '‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏°', '‡∏ñ‡∏±‡πà‡∏ß‡∏Ñ‡∏±‡πà‡∏ß', '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏ö', '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°',
                            '‡∏Ç‡∏ô‡∏°‡∏Ñ‡∏£‡∏Å', '‡∏ó‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö', '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ó‡∏≠‡∏î', '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡∏ï‡πâ‡∏°', '‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡∏®‡∏≠‡∏ö',
                            '‡∏Ç‡∏ô‡∏°‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á', '‡∏•‡∏π‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏≠‡∏î', '‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á', '‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡∏™‡∏≤‡∏ô', '‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö'
                        ],
                        drinks: [
                            '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î', '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', '‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏≥', '‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡∏ô‡∏°‡∏™‡∏î‡∏à‡∏∑‡∏î',
                            '‡∏ô‡πâ‡∏≥‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', '‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°', '‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ', '‡∏ô‡πâ‡∏≥‡∏Å‡∏∞‡∏ó‡∏¥',
                            '‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ç‡∏ä‡∏±‡∏ô', '‡∏ä‡∏≤‡∏≠‡∏π‡πà‡∏´‡∏•‡∏á', '‡∏ô‡πâ‡∏≥‡πÅ‡∏ï‡∏á‡πÇ‡∏°', '‡∏ô‡∏°‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå', '‡∏ô‡πâ‡∏≥‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß'
                        ]
                    };
                    
                    const foodOptions = basicMealData[appState.foodType] || basicMealData.thai;
                    
                    // Shuffle the food options array
                    const shuffledOptions = [...foodOptions].sort(() => Math.random() - 0.5);
                    
                    appState.selectedMeals.forEach((mealTime, index) => {
                        // Use different meals from the shuffled array
                        const mealIndex = index % shuffledOptions.length;
                        const selectedFood = shuffledOptions[mealIndex];
                        
                        fallbackMeals.push({
                            food_name: selectedFood,
                            meal_time: mealTime,
                            calories: 250 + Math.floor(Math.random() * 300),
                            protein: 10 + Math.floor(Math.random() * 25),
                            carbs: 20 + Math.floor(Math.random() * 40),
                            fat: 5 + Math.floor(Math.random() * 20),
                            tip: `${selectedFood} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö${mealTime === 'breakfast' ? '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤' : mealTime === 'lunch' ? '‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô' : '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô'}`
                        });
                    });
                    
                    // Update current meal plan
                    currentMealPlan = [...fallbackMeals];
                    
                    displayMealPlan(fallbackMeals);
                    showStep('results');
                }
            }, 500);
        }

        function resetApp() {
            // Keep user ID and goal calories, reset only selection data
            const savedUserId = appState.lineUserId;
            const savedGoalCalories = appState.goalCalories;
            
            appState = { 
                foodType: '', 
                selectedMeals: [], 
                focus: '', 
                lineUserId: savedUserId,
                goalCalories: savedGoalCalories
            };
            
            // Reset previously selected meals history
            previouslySelectedMeals = [];
            
            // Reset meal selection buttons
            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                const btn = document.getElementById(mealType + '-btn');
                const check = document.getElementById(mealType + '-check');
                if (btn && check) {
                    btn.style.backgroundColor = '#DDB4A5';
                    btn.style.borderColor = '#DDB4A5';
                    btn.style.opacity = '1';
                    check.classList.add('hidden');
                }
            });
            
            // Reset continue button
            const continueBtn = document.getElementById('continue-btn');
            if (continueBtn) {
                continueBtn.disabled = true;
                continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.remove('hover:scale-105');
            }
            
            showStep('step1');
        }

        function goToHome() {
            resetApp();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeLIFF();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9710225d32ee7b70',t:'MTc1NTUwNjcxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
