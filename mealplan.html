<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .bg-primary { background-color: #cc1e0f; }
        .border-accent { border-color: #e9e2d0; }
        .text-accent { color: #e9e2d0; }
        .hover-accent:hover { background-color: #e9e2d0; color: #cc1e0f; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-glow { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(233, 226, 208, 0.3); }
            50% { box-shadow: 0 0 30px rgba(233, 226, 208, 0.6); }
        }
    </style>
</head>
<body class="bg-primary min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8 slide-in">
            <h1 class="text-3xl font-bold text-accent mb-2">ü§î ‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å</h1>
            <h2 class="text-2xl font-semibold mb-4">‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏• ‚ú®</h2>
            <p class="text-lg opacity-90">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏≠‡∏á!</p>
        </div>

        <!-- Step 1: Food Type Selection -->
        <div id="step1" class="slide-in">
            <div class="bg-white/10 rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-xl font-semibold mb-4 text-center">üçΩÔ∏è ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ô‡∏ß‡πÑ‡∏´‡∏ô‡∏î‡∏µ?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="selectFoodType('thai')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">üáπüá≠</div>
                        <div class="font-medium">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</div>
                    </button>
                    <button onclick="selectFoodType('western')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">üçù</div>
                        <div class="font-medium">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á</div>
                    </button>
                    <button onclick="selectFoodType('noodle')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">üçú</div>
                        <div class="font-medium">‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</div>
                    </button>
                    <button onclick="selectFoodType('healthy')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">ü•ó</div>
                        <div class="font-medium">‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                    </button>
                    <button onclick="selectFoodType('vegan')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">üßò</div>
                        <div class="font-medium">‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à</div>
                    </button>
                    <button onclick="selectFoodType('snack')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">üçø</div>
                        <div class="font-medium">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</div>
                    </button>
                    <button onclick="selectFoodType('drinks')" class="food-type-btn bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105">
                        <div class="text-2xl mb-2">üßã</div>
                        <div class="font-medium">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Meal Selection -->
        <div id="step2" class="hidden slide-in">
            <div class="bg-white/10 rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-xl font-semibold mb-2 text-center">üßÆ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á?</h3>
                <p class="text-center text-sm opacity-80 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏∞</p>
                <div class="space-y-3">
                    <button onclick="toggleMeal('breakfast')" id="breakfast-btn" class="meal-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üåÖ</span>
                        <span class="font-medium">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</span>
                        <span class="ml-auto text-xl hidden" id="breakfast-check">‚úÖ</span>
                    </button>
                    <button onclick="toggleMeal('lunch')" id="lunch-btn" class="meal-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">‚òÄÔ∏è</span>
                        <span class="font-medium">‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</span>
                        <span class="ml-auto text-xl hidden" id="lunch-check">‚úÖ</span>
                    </button>
                    <button onclick="toggleMeal('dinner')" id="dinner-btn" class="meal-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üåô</span>
                        <span class="font-medium">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô</span>
                        <span class="ml-auto text-xl hidden" id="dinner-check">‚úÖ</span>
                    </button>
                </div>
                <button onclick="proceedToStep3()" id="continue-btn" class="w-full mt-4 bg-accent text-primary font-semibold rounded-xl p-4 transition-all duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed" disabled>
                    ‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚û°Ô∏è
                </button>
            </div>
        </div>

        <!-- Step 3: Focus Selection -->
        <div id="step3" class="hidden slide-in">
            <div class="bg-white/10 rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-xl font-semibold mb-2 text-center">üí™ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏´‡∏°</h3>
                <p class="text-center text-sm opacity-80 mb-4">‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô ‡πÜ</p>
                <div class="space-y-3">
                    <button onclick="selectFocus('protein')" class="focus-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">ü•©</span>
                        <span class="font-medium">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á</span>
                    </button>
                    <button onclick="selectFocus('lowcarb')" class="focus-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üßò‚Äç‚ôÄÔ∏è</span>
                        <span class="font-medium">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥</span>
                    </button>
                    <button onclick="selectFocus('lowcal')" class="focus-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üíß</span>
                        <span class="font-medium">‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ</span>
                    </button>
                    <button onclick="selectFocus('tasty')" class="focus-btn w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üß°</span>
                        <span class="font-medium">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-8">
            <div class="pulse-glow bg-white/20 rounded-2xl p-8 border-2 border-accent">
                <div class="text-4xl mb-4">ü§ñ</div>
                <h3 class="text-xl font-semibold mb-2">‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ...</h3>
                <p class="opacity-80">‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡∏µ ‡πÜ ‡πÉ‡∏´‡πâ ‚ú®</p>
                <div class="mt-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent mx-auto"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden slide-in">
            <div class="bg-white/10 rounded-2xl p-6 border-2 border-accent mb-6">
                <h3 class="text-2xl font-bold text-center mb-4 text-accent">üç± Meal Plan ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</h3>
                <div id="mealPlan" class="space-y-4 mb-6">
                    <!-- Meals will be populated here -->
                </div>
                <div id="summary" class="bg-white/10 rounded-xl p-4 mb-4">
                    <!-- Summary will be populated here -->
                </div>
                <div id="tip" class="bg-accent/20 rounded-xl p-4 mb-4">
                    <h4 class="font-semibold mb-2">üí° ‡∏ó‡∏£‡∏¥‡∏õ!! ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•:</h4>
                    <p id="tipText" class="text-sm"></p>
                </div>
                <div class="space-y-3">
                    <button onclick="resetApp()" class="w-full bg-white/20 hover-accent border-2 border-accent rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üîÑ</span>
                        <span class="font-medium">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                    <button onclick="goToHome()" class="w-full bg-accent text-primary font-semibold rounded-xl p-4 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <span class="text-2xl mr-3">üè†</span>
                        <span class="font-medium">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden form for LINE ID -->
        <input type="hidden" id="lineId" name="lineId">
    </div>

    <script>
        // App state
        let appState = {
            foodType: '',
            selectedMeals: [],
            focus: '',
            lineUserId: '',
            goalCalories: 1300
        };

        // Initialize Supabase
        const supabaseUrl = 'https://lvtdqeerzxpznnayccmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Mock Supabase data (replace with actual Supabase connection)
        const mockMealsData = {
            thai: [
                { food_name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢', meal_time: 'breakfast', calories: 320, protein: 15, carbs: 45, fat: 8, tip: '‡∏Å‡∏¥‡∏ô‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏î‡∏µ ‡πÜ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô!' },
                { food_name: '‡∏•‡∏≤‡∏ö‡∏≠‡∏Å‡πÑ‡∏Å‡πà', meal_time: 'lunch', calories: 450, protein: 35, carbs: 25, fat: 12, tip: '‡∏•‡∏≤‡∏ö‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢' },
                { food_name: '‡πÅ‡∏Å‡∏á‡∏à‡∏∑‡∏î‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', meal_time: 'dinner', calories: 380, protein: 28, carbs: 15, fat: 18, tip: '‡πÅ‡∏Å‡∏á‡∏à‡∏∑‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô' }
            ],
            western: [
                { food_name: 'Scrambled Eggs Toast', meal_time: 'breakfast', calories: 350, protein: 18, carbs: 30, fat: 15, tip: '‡πÑ‡∏Ç‡πà‡∏Å‡∏ß‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô' },
                { food_name: 'Grilled Chicken Salad', meal_time: 'lunch', calories: 420, protein: 40, carbs: 20, fat: 10, tip: '‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô' },
                { food_name: 'Salmon Steak', meal_time: 'dinner', calories: 480, protein: 35, carbs: 10, fat: 25, tip: '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô‡∏°‡∏µ‡πÇ‡∏≠‡πÄ‡∏°‡∏Å‡πâ‡∏≤ 3 ‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à' }
            ],
            healthy: [
                { food_name: 'Quinoa Bowl', meal_time: 'breakfast', calories: 300, protein: 12, carbs: 40, fat: 8, tip: '‡∏Ñ‡∏ß‡∏¥‡∏ô‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ü‡∏π‡πâ‡∏î ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' },
                { food_name: 'Buddha Bowl', meal_time: 'lunch', calories: 380, protein: 15, carbs: 45, fat: 12, tip: 'Buddha Bowl ‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà' },
                { food_name: 'Steamed Fish', meal_time: 'dinner', calories: 320, protein: 30, carbs: 5, fat: 15, tip: '‡∏õ‡∏•‡∏≤‡∏ô‡∏∂‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô' }
            ],
            drinks: [
                { food_name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡∏õ‡∏±‡πà‡∏ô', meal_time: 'breakfast', calories: 120, protein: 2, carbs: 30, fat: 0, tip: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ã‡∏µ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô!' },
                { food_name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', meal_time: 'lunch', calories: 80, protein: 0, carbs: 20, fat: 0, tip: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏µ‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≤‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                { food_name: '‡∏ô‡∏°‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå', meal_time: 'dinner', calories: 60, protein: 3, carbs: 8, fat: 3, tip: '‡∏ô‡∏°‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏•‡∏Ñ‡πÇ‡∏ï‡∏™ ‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô' }
            ]
        };

        // Get goal calories from Supabase
        async function getGoalCalories(userId) {
            try {
                const { data, error } = await supabase
                    .from('tdee_form')
                    .select('goal_calories')
                    .eq('line_user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('Error fetching goal calories:', error);
                    return 1300; // Default value
                }

                if (data && data.length > 0) {
                    return data[0].goal_calories || 1300;
                }
                
                return 1300; // Default if no data found
            } catch (error) {
                console.error('Error:', error);
                return 1300;
            }
        }

        // Initialize LIFF
        async function initializeLIFF() {
            try {
                // Replace with your actual LIFF ID
                await liff.init({ liffId: "2007859046-yEGnq0GX" });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                appState.lineUserId = profile.userId;
                document.getElementById("lineId").value = profile.userId;
                
                // Get goal calories from database
                appState.goalCalories = await getGoalCalories(profile.userId);
            } catch (error) {
                console.log("LIFF initialization failed:", error);
                // For demo purposes, use a mock user ID
                appState.lineUserId = "demo_user_" + Date.now();
                appState.goalCalories = 1300; // Default for demo
            }
        }

        // Step functions
        function selectFoodType(type) {
            appState.foodType = type;
            showStep('step2');
        }

        function toggleMeal(mealType) {
            const index = appState.selectedMeals.indexOf(mealType);
            const btn = document.getElementById(mealType + '-btn');
            const check = document.getElementById(mealType + '-check');
            
            if (index > -1) {
                // Remove meal
                appState.selectedMeals.splice(index, 1);
                btn.classList.remove('bg-accent', 'text-primary');
                btn.classList.add('bg-white/20');
                check.classList.add('hidden');
            } else {
                // Add meal
                appState.selectedMeals.push(mealType);
                btn.classList.remove('bg-white/20');
                btn.classList.add('bg-accent', 'text-primary');
                check.classList.remove('hidden');
            }
            
            // Update continue button
            const continueBtn = document.getElementById('continue-btn');
            if (appState.selectedMeals.length > 0) {
                continueBtn.disabled = false;
                continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.add('hover:scale-105');
            } else {
                continueBtn.disabled = true;
                continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.remove('hover:scale-105');
            }
        }

        function proceedToStep3() {
            if (appState.selectedMeals.length > 0) {
                showStep('step3');
            }
        }

        function selectFocus(focus) {
            appState.focus = focus;
            generateMealPlan();
        }

        function showStep(stepId) {
            // Hide all steps
            ['step1', 'step2', 'step3', 'loading', 'results'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Show target step
            document.getElementById(stepId).classList.remove('hidden');
        }

        function generateMealPlan() {
            showStep('loading');
            
            setTimeout(() => {
                const meals = mockMealsData[appState.foodType] || mockMealsData.thai;
                const selectedMeals = [];
                
                // Get meals for selected meal times
                appState.selectedMeals.forEach(mealTime => {
                    const mealForTime = meals.find(meal => meal.meal_time === mealTime);
                    if (mealForTime) {
                        selectedMeals.push(mealForTime);
                    }
                });
                
                displayMealPlan(selectedMeals);
                showStep('results');
                
                // Save to Supabase (mock)
                saveMealPlan(selectedMeals);
            }, 2000);
        }

        function displayMealPlan(meals) {
            const mealPlanDiv = document.getElementById('mealPlan');
            const summaryDiv = document.getElementById('summary');
            const tipDiv = document.getElementById('tipText');
            
            let totalCalories = 0;
            let totalProtein = 0;
            
            const mealEmojis = {
                breakfast: 'ü•£',
                lunch: 'üç≤',
                dinner: 'ü•ó'
            };
            
            const mealNames = {
                breakfast: '‡πÄ‡∏ä‡πâ‡∏≤',
                lunch: '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
                dinner: '‡πÄ‡∏¢‡πá‡∏ô'
            };
            
            mealPlanDiv.innerHTML = meals.map((meal) => {
                totalCalories += meal.calories;
                totalProtein += meal.protein;
                
                return `
                    <div class="bg-white/10 rounded-xl p-4">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">${mealEmojis[meal.meal_time]}</span>
                            <span class="font-semibold">${mealNames[meal.meal_time]}:</span>
                        </div>
                        <div class="ml-8">
                            <div class="font-medium">${meal.food_name}</div>
                            <div class="text-sm opacity-80">(${meal.calories} kcal)</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            summaryDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-semibold mb-2">‚úÖ ‡∏£‡∏ß‡∏° ${totalCalories} kcal / ‡πÄ‡∏õ‡πâ‡∏≤ ${appState.goalCalories.toLocaleString()} kcal</div>
                    <div class="text-sm opacity-90">üí¨ ‡πÅ‡∏ô‡∏ß: ${getFoodTypeName(appState.foodType)} / ${getFocusName(appState.focus)}</div>
                </div>
            `;
            
            // Random tip
            const randomTip = meals[Math.floor(Math.random() * meals.length)].tip;
            tipDiv.textContent = randomTip;
        }

        function getFoodTypeName(type) {
            const names = {
                thai: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',
                western: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á',
                noodle: '‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß',
                healthy: '‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                vegan: '‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à',
                snack: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô',
                drinks: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'
            };
            return names[type] || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢';
        }

        function getFocusName(focus) {
            const names = {
                protein: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á',
                lowcarb: '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥',
                lowcal: '‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ',
                tasty: '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            };
            return names[focus] || '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô';
        }

        async function saveMealPlan(meals) {
            // Mock Supabase save
            const planData = {
                line_user_id: appState.lineUserId,
                food_type: appState.foodType,
                selected_meals: appState.selectedMeals,
                focus: appState.focus,
                meals: meals,
                created_at: new Date().toISOString()
            };
            
            console.log('Saving meal plan:', planData);
            // In real implementation, save to Supabase here
        }

        function resetApp() {
            // Keep user ID and goal calories, reset only selection data
            const savedUserId = appState.lineUserId;
            const savedGoalCalories = appState.goalCalories;
            
            appState = { 
                foodType: '', 
                selectedMeals: [], 
                focus: '', 
                lineUserId: savedUserId,
                goalCalories: savedGoalCalories
            };
            
            // Reset meal selection buttons
            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                const btn = document.getElementById(mealType + '-btn');
                const check = document.getElementById(mealType + '-check');
                if (btn && check) {
                    btn.classList.remove('bg-accent', 'text-primary');
                    btn.classList.add('bg-white/20');
                    check.classList.add('hidden');
                }
            });
            
            // Reset continue button
            const continueBtn = document.getElementById('continue-btn');
            if (continueBtn) {
                continueBtn.disabled = true;
                continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.remove('hover:scale-105');
            }
            
            showStep('step1');
        }

        function goToHome() {
            resetApp();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeLIFF();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'970fb3a785667b56',t:'MTc1NTUwMjE4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
