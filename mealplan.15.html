<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .meal-card {
            transition: all 0.3s ease;
        }
        .meal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-active {
            background: #cc1e0f;
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .food-type-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .selected {
            background: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
    </style>
</head>
<body style="background-color: #cc1e0f;" class="min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <h1 class="text-lg md:text-xl font-bold text-center" style="color: #cc1e0f;">ü§î ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•!!</h1>
            <p class="text-gray-600 text-center mt-2 text-sm">‡πÄ‡∏°‡∏ô‡∏π‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏´‡∏≤‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏ó‡∏¢</p>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex justify-center space-x-4 mb-8">
            <div id="step1-indicator" class="step-indicator step-active w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">1</div>
            <div class="w-16 h-1 bg-white/30 self-center"></div>
            <div id="step2-indicator" class="step-indicator bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">2</div>
            <div class="w-16 h-1 bg-white/30 self-center"></div>
            <div id="step3-indicator" class="step-indicator bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">3</div>
            <div class="w-16 h-1 bg-white/30 self-center"></div>
            <div id="step4-indicator" class="step-indicator bg-white/30 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">4</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-4 pb-8">
        <!-- Step 1: Food Type Selection -->
        <div id="step1" class="bg-white rounded-2xl shadow-xl p-8 mb-6 fade-in" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-6" style="color: #cc1e0f;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö üç¥</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('thai')">
                    <div class="text-2xl mb-1">üáπüá≠</div>
                    <div class="font-semibold text-sm">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</div>
                </button>
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('western')">
                    <div class="text-2xl mb-1">üçù</div>
                    <div class="font-semibold text-sm">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á</div>
                </button>
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('noodle')">
                    <div class="text-2xl mb-1">üçú</div>
                    <div class="font-semibold text-sm">‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</div>
                </button>
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('healthy')">
                    <div class="text-2xl mb-1">ü•ó</div>
                    <div class="font-semibold text-sm">‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                </button>
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('vgan')">
                    <div class="text-2xl mb-1">üßò</div>
                    <div class="font-semibold text-sm">‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à</div>
                </button>
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('drink')">
                    <div class="text-2xl mb-1">üßã</div>
                    <div class="font-semibold text-sm">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</div>
                </button>
                <button class="food-type-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectFoodType('snack')">
                    <div class="text-2xl mb-1">üçø</div>
                    <div class="font-semibold text-sm">‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Number of Meals -->
        <div id="step2" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-4" style="color: #cc1e0f;">‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏¥‡∏ô‡∏Å‡∏µ‡πà‡∏°‡∏∑‡πâ‡∏≠‡∏î‡∏µ‡∏à‡πä‡∏∞? ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÜ üßÆ</h2>
            <p class="text-center text-gray-600 mb-6 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏∞ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô</p>
            <div class="flex flex-col space-y-3 mt-8">
                <button class="meal-btn bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200 flex items-center space-x-3" onclick="toggleMeal('breakfast', this)">
                    <div class="text-xl">üåÖ</div>
                    <div class="font-semibold text-sm">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</div>
                </button>
                <button class="meal-btn bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200 flex items-center space-x-3" onclick="toggleMeal('lunch', this)">
                    <div class="text-xl">‚òÄÔ∏è</div>
                    <div class="font-semibold text-sm">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</div>
                </button>
                <button class="meal-btn bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200 flex items-center space-x-3" onclick="toggleMeal('dinner', this)">
                    <div class="text-xl">üåÜ</div>
                    <div class="font-semibold text-sm">‡πÄ‡∏¢‡πá‡∏ô</div>
                </button>
            </div>
            <div class="text-center mt-8">
                <button onclick="confirmMealSelection()" id="confirmMeals" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                    ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
            </div>
        </div>

        <!-- Step 3: Preferences -->
        <div id="step3" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-4" style="color: #cc1e0f;">‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏´‡∏° ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô‡πÜ üí™</h2>
            <div class="grid grid-cols-2 gap-4 mt-8">
                <button class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectPreference('high-protein')">
                    <div class="text-2xl mb-1">ü•©</div>
                    <div class="font-semibold text-sm">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á</div>
                </button>
                <button class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectPreference('low-carb')">
                    <div class="text-2xl mb-1">üßò‚Äç‚ôÄÔ∏è</div>
                    <div class="font-semibold text-sm">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥</div>
                </button>
                <button class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectPreference('calorie-control')">
                    <div class="text-2xl mb-1">üíß</div>
                    <div class="font-semibold text-sm">‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ</div>
                </button>
                <button class="pref-btn bg-white text-gray-700 p-3 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200" onclick="selectPreference('just-delicious')">
                    <div class="text-2xl mb-1">üß°</div>
                    <div class="font-semibold text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</div>
                </button>
            </div>
            <div class="text-center mt-8">
                <button onclick="submitPreferences()" id="submitPreferences" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                    üçΩÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                </button>
            </div>
        </div>

        <!-- Step 4: Generated Meal Plan -->
        <div id="step4" class="bg-white rounded-2xl shadow-xl p-8 mb-6 hidden" style="border: 3px solid #e9e2d0;">
            <h2 class="text-base md:text-lg font-bold text-center mb-6" style="color: #cc1e0f;">üç± Meal Plan ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</h2>
            
            <div id="meal-plan-content" class="space-y-4">
                <!-- Meal plan will be generated here -->
            </div>
            
            <div id="summary-section" class="mt-8 p-4 bg-gray-50 rounded-xl">
                <div id="summary" class="text-center">
                    <!-- Summary will be generated here -->
                </div>
            </div>
            
            <div class="flex justify-center space-x-3 mt-6">
                <button onclick="regeneratePlan()" class="bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200 text-sm">
                    üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà
                </button>
                <button onclick="goBackToStart()" class="bg-white text-gray-700 px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-300 border border-gray-200 text-sm">
                    üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
        const LIFF_ID = '2007859046-yEGnq0GX'; // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        
        let supabaseClient = null;
        let lineUserId = null;
        let userProfile = null;
        
        // Initialize LIFF
        async function initializeLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                console.log('LIFF initialized successfully');
                
                if (!liff.isLoggedIn()) {
                    liff.login(); // Redirect to LINE Login
                    return;
                }
                
                // Get user profile
                userProfile = await liff.getProfile();
                lineUserId = userProfile.userId;
                console.log('LINE user ID:', lineUserId);
                console.log('User profile:', userProfile);
                
                // Update UI with user info
                updateUserInfo();
                
            } catch (error) {
                console.error('LIFF initialization failed:', error);
            }
        }
        
        // Initialize Supabase (‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
        try {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
            }
        } catch (error) {
            console.log('Supabase not available, using fallback data');
        }
        
        // Update UI with user information
        function updateUserInfo() {
            if (userProfile) {
                const headerElement = document.querySelector('h1');
                if (headerElement) {
                    headerElement.innerHTML = `ü§î ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${userProfile.displayName}! ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•!!`;
                }
            }
        }

        let currentStep = 1;
        let selectedData = {
            foodType: '',
            meals: [],
            preference: ''
        };

        function selectFoodType(type) {
            console.log('Food type selected:', type);
            selectedData.foodType = type;
            
            // Visual feedback
            document.querySelectorAll('.food-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.food-type-btn').classList.add('selected');
            
            // Go to next step after short delay
            setTimeout(() => {
                nextStep();
            }, 500);
        }

        function toggleMeal(mealType, button) {
            console.log('Meal toggled:', mealType);
            const index = selectedData.meals.indexOf(mealType);
            
            if (index > -1) {
                selectedData.meals.splice(index, 1);
                button.classList.remove('selected');
            } else {
                selectedData.meals.push(mealType);
                button.classList.add('selected');
            }
            
            // Enable/disable confirm button
            const confirmBtn = document.getElementById('confirmMeals');
            confirmBtn.disabled = selectedData.meals.length === 0;
        }

        function confirmMealSelection() {
            console.log('Meals confirmed:', selectedData.meals);
            if (selectedData.meals.length === 0) return;
            nextStep();
        }

        function selectPreference(pref) {
            console.log('Preference selected:', pref);
            selectedData.preference = pref;
            
            // Visual feedback
            document.querySelectorAll('.pref-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.pref-btn').classList.add('selected');
            
            // Enable submit button
            document.getElementById('submitPreferences').disabled = false;
        }

        async function submitPreferences() {
            console.log('Submitting preferences:', selectedData);
            if (!selectedData.preference) return;
            
            await generateMealPlan();
            nextStep();
        }

        function nextStep() {
            console.log('Moving to next step from:', currentStep);
            
            // Hide current step
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            
            // Update step indicator
            document.getElementById(`step${currentStep}-indicator`).classList.remove('step-active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('step-completed');
            
            // Show next step
            currentStep++;
            if (currentStep <= 4) {
                document.getElementById(`step${currentStep}`).classList.remove('hidden');
                document.getElementById(`step${currentStep}`).classList.add('fade-in');
                
                if (currentStep <= 4) {
                    document.getElementById(`step${currentStep}-indicator`).classList.remove('bg-white/30');
                    document.getElementById(`step${currentStep}-indicator`).classList.add('step-active');
                }
            }
        }

        async function generateMealPlan() {
            console.log('Generating meal plan...');
            
            let meals = [];
            let totalCalories = 0;
            let allTips = [];
            
            try {
                if (supabaseClient) {
                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase
                    for (const mealType of selectedData.meals) {
                        let query = supabaseClient
                            .from('meals_database')
                            .select('*')
                            .eq('food_type', selectedData.foodType);
                        
                        // Filter by meal time if available
                        const mealTimeMap = {
                            'breakfast': 'breakfast',
                            'lunch': 'lunch',
                            'dinner': 'dinner'
                        };
                        
                        if (mealTimeMap[mealType]) {
                            query = query.eq('meal_time', mealTimeMap[mealType]);
                        }
                        
                        // Apply preference filters
                        if (selectedData.preference === 'high-protein') {
                            query = query.gte('protein', 15);
                        } else if (selectedData.preference === 'low-carb') {
                            query = query.lte('carbs', 30);
                        } else if (selectedData.preference === 'calorie-control') {
                            query = query.lte('calories', 400);
                        }
                        
                        const { data: mealData, error } = await query.limit(10);
                        
                        if (!error && mealData && mealData.length > 0) {
                            const randomMeal = mealData[Math.floor(Math.random() * mealData.length)];
                            meals.push({
                                meal: getMealDisplayName(mealType),
                                food: randomMeal.food_name,
                                calories: randomMeal.calories || 350,
                                protein: randomMeal.protein,
                                carbs: randomMeal.carbs,
                                fat: randomMeal.fat,
                                price_range: randomMeal.price_range,
                                ingredients: randomMeal.ingredients
                            });
                            
                            // ‡πÄ‡∏Å‡πá‡∏ö tip ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                            if (randomMeal.tip) {
                                allTips.push(randomMeal.tip);
                            }
                        } else {
                            // Fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô database
                            const fallbackMeal = getFallbackMeal(mealType, selectedData.foodType);
                            meals.push(fallbackMeal);
                        }
                    }
                } else {
                    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Supabase
                    meals = generateFallbackMeals();
                }
            } catch (error) {
                console.error('Database error:', error);
                meals = generateFallbackMeals();
            }
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å meal plan ‡∏•‡∏á Supabase ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ LINE user ID
            if (supabaseClient && lineUserId) {
                await saveMealPlan(meals, totalCalories);
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const mealEmojis = {
                "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤": "ü•£",
                "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô": "üç≤",
                "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô": "ü•ó"
            };

            let planHtml = '';
            meals.forEach(meal => {
                totalCalories += meal.calories;
                
                planHtml += `
                    <div class="meal-card bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border-l-4" style="border-left-color: #cc1e0f;">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${mealEmojis[meal.meal]}</span>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${meal.meal}: ${meal.food}</div>
                                <div class="text-sm text-gray-600">${meal.calories} kcal</div>
                                ${meal.protein ? `<div class="text-xs text-gray-500 mt-1">
                                    ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ${meal.protein}g | ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö ${meal.carbs}g | ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô ${meal.fat}g
                                </div>` : ''}
                                ${meal.price_range ? `<div class="text-xs text-green-600 mt-1">üí∞ ${meal.price_range} ‡∏ö‡∏≤‡∏ó</div>` : ''}
                            </div>
                        </div>
                        ${meal.ingredients ? `<div class="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                            ü•ò ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°: ${meal.ingredients}
                        </div>` : ''}
                    </div>
                `;
            });

            document.getElementById('meal-plan-content').innerHTML = planHtml;

            const targetCalories = 1300;
            const foodTypeText = {
                'thai': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',
                'western': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á',
                'noodle': '‡πÄ‡∏™‡πâ‡∏ô/‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß',
                'healthy': '‡∏Ñ‡∏•‡∏µ‡∏ô/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                'vgan': '‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥/‡πÄ‡∏à',
                'drink': '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°',
                'snack': '‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô'
            };

            const prefText = {
                'high-protein': '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á',
                'low-carb': '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ï‡πà‡∏≥',
                'calorie-control': '‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡∏• ‡πÜ',
                'just-delicious': '‡∏Ç‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            };

            document.getElementById('summary').innerHTML = `
                <div class="text-base font-semibold mb-2">
                    ‚úÖ ‡∏£‡∏ß‡∏° ${totalCalories} kcal / ‡πÄ‡∏õ‡πâ‡∏≤ ${targetCalories} kcal
                </div>
                <div class="text-gray-600 text-sm">
                    üí¨ ‡πÅ‡∏ô‡∏ß: ${foodTypeText[selectedData.foodType]} / ${prefText[selectedData.preference]}
                </div>
            `;
            
            // ‡πÅ‡∏™‡∏î‡∏á Tips ‡∏à‡∏≤‡∏Å database
            displayTips(allTips);
        }

        function getMealDisplayName(mealType) {
            const displayNames = {
                'breakfast': '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤',
                'lunch': '‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
                'dinner': '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô'
            };
            return displayNames[mealType] || '‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        }

        function getFallbackMeal(mealType, foodType) {
            const fallbackMeals = {
                thai: {
                    breakfast: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡πÇ‡∏à‡πä‡∏Å‡∏´‡∏°‡∏π + ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°", calories: 320 },
                    lunch: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∏‡πâ‡∏á", calories: 450 },
                    dinner: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á + ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢", calories: 380 }
                },
                western: {
                    breakfast: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á + ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", calories: 300 },
                    lunch: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡πÅ‡∏Æ‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå + ‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢", calories: 520 },
                    dinner: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡∏ã‡∏µ‡∏ã‡∏≤‡∏£‡πå‡∏™‡∏•‡∏±‡∏î", calories: 380 }
                },
                noodle: {
                    breakfast: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", food: "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡πÉ‡∏™", calories: 350 },
                    lunch: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", food: "‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢", calories: 420 },
                    dinner: { meal: "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", food: "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á", calories: 400 }
                }
            };

            const mealData = fallbackMeals[foodType] || fallbackMeals.thai;
            const meal = mealData[mealType] || mealData.lunch;
            return {
                meal: getMealDisplayName(mealType),
                food: meal.food,
                calories: meal.calories
            };
        }

        function generateFallbackMeals() {
            let meals = [];
            selectedData.meals.forEach(mealType => {
                meals.push(getFallbackMeal(mealType, selectedData.foodType));
            });
            return meals;
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å meal plan ‡∏•‡∏á Supabase
        async function saveMealPlan(meals, totalCalories) {
            try {
                const mealPlanData = {
                    line_user_id: lineUserId,
                    user_name: userProfile?.displayName || 'Unknown',
                    food_type: selectedData.foodType,
                    preference: selectedData.preference,
                    meals: selectedData.meals,
                    meal_plan: meals,
                    total_calories: totalCalories,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabaseClient
                    .from('meal_plans')
                    .insert([mealPlanData]);

                if (error) {
                    console.error('Error saving meal plan:', error);
                } else {
                    console.log('Meal plan saved successfully:', data);
                }
            } catch (error) {
                console.error('Error saving meal plan:', error);
            }
        }

        function displayTips(databaseTips) {
            // Tips ‡∏à‡∏≤‡∏Å database
            let tipsToShow = [...databaseTips];
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° fallback tips ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏≤‡∏Å database
            if (tipsToShow.length === 0) {
                const fallbackTips = {
                    thai: [
                        "üå∂Ô∏è ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢‡∏ô‡∏∞ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ä‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î",
                        "ü•¨ ‡∏Ç‡∏≠‡∏ú‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ô‡∏∞ ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°",
                        "üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏¥‡∏ô"
                    ],
                    western: [
                        "üçü ‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏Å‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÅ‡∏Ñ‡∏•",
                        "ü•§ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤",
                        "üßÄ ‡∏Ç‡∏≠‡∏ä‡∏µ‡∏™‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏ô"
                    ],
                    noodle: [
                        "üçú ‡∏ô‡πâ‡∏≥‡∏ã‡∏∏‡∏õ‡∏î‡∏∑‡πà‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ä‡∏≤‡∏°‡∏û‡∏≠ ‡πÄ‡∏Ñ‡πá‡∏°‡πÄ‡∏Å‡∏¥‡∏ô",
                        "ü•© ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ 10-20 ‡∏ö‡∏≤‡∏ó ‡∏Ñ‡∏∏‡πâ‡∏°‡∏°‡∏≤‡∏Å",
                        "üåø ‡∏Ç‡∏≠‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡∏ô"
                    ],
                    healthy: [
                        "ü•ë ‡∏≠‡∏∞‡πÇ‡∏ß‡∏Ñ‡∏≤‡πÇ‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏î‡∏µ ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏¥‡πà‡∏°‡∏ô‡∏≤‡∏ô",
                        "ü•ú ‡πÇ‡∏£‡∏¢‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏î‡πâ‡∏ß‡∏¢",
                        "üçã ‡∏ö‡∏µ‡∏ö‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡πÄ‡∏´‡∏•‡πá‡∏Å"
                    ],
                    vgan: [
                        "üå± ‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏ó‡∏≠‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏°",
                        "ü•ï ‡∏ú‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏Å‡∏™‡∏µ ‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö",
                        "üçÑ ‡πÄ‡∏´‡πá‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏™‡∏≠‡∏π‡∏°‡∏≤‡∏°‡∏¥ ‡∏´‡∏≠‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢"
                    ],
                    drink: [
                        "üßä ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏∑‡∏î",
                        "üçØ ‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ô‡∏∞ ‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÑ‡∏î‡πâ",
                        "ü•õ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡∏°‡∏Ç‡πâ‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏°‡∏™‡∏î"
                    ],
                    snack: [
                        "ü•ú ‡∏ñ‡∏±‡πà‡∏ß‡∏Ñ‡∏±‡πà‡∏ß‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏≠‡∏î ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤",
                        "üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏´‡πâ‡∏á ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤",
                        "üçø ‡∏õ‡πä‡∏≠‡∏õ‡∏Ñ‡∏≠‡∏£‡πå‡∏ô‡∏£‡∏™‡∏à‡∏∑‡∏î ‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ‡∏ï‡πà‡∏≠‡πÉ‡∏à"
                    ]
                };

                const foodTypeTips = fallbackTips[selectedData.foodType] || fallbackTips.thai;
                tipsToShow = foodTypeTips.slice(0, 2);
            }

            // ‡πÅ‡∏™‡∏î‡∏á Tips section
            if (tipsToShow.length > 0) {
                let tipsHtml = '';
                tipsToShow.forEach(tip => {
                    tipsHtml += `
                        <div class="flex items-start space-x-2">
                            <span class="text-orange-500">‚Ä¢</span>
                            <span>${tip}</span>
                        </div>
                    `;
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Tips section ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                if (!document.getElementById('tips-section')) {
                    const tipsSection = document.createElement('div');
                    tipsSection.id = 'tips-section';
                    tipsSection.className = 'mt-6 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-200';
                    tipsSection.innerHTML = `
                        <h3 class="text-base font-semibold text-orange-800 mb-3 text-center">üí° ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÜ ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•</h3>
                        <div id="tips-content" class="space-y-2 text-sm text-orange-700"></div>
                    `;
                    document.getElementById('summary-section').after(tipsSection);
                }

                document.getElementById('tips-content').innerHTML = tipsHtml;
                document.getElementById('tips-section').classList.remove('hidden');
            }
        }

        async function regeneratePlan() {
            console.log('Regenerating plan...');
            await generateMealPlan();
        }

        function goBackToStart() {
            console.log('Going back to start...');
            
            // Reset data
            selectedData = {
                foodType: '',
                meals: [],
                preference: ''
            };
            
            // Hide all steps except step 1
            for (let i = 2; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            document.getElementById('step1').classList.remove('hidden');
            
            // Reset step indicators
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                indicator.classList.remove('step-active', 'step-completed');
                if (i === 1) {
                    indicator.classList.add('step-active');
                } else {
                    indicator.classList.add('bg-white/30', 'text-white');
                }
            }
            
            // Reset current step
            currentStep = 1;
            
            // Remove selections
            document.querySelectorAll('.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Reset buttons
            document.getElementById('confirmMeals').disabled = true;
            document.getElementById('submitPreferences').disabled = true;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('Script loaded successfully!');
            
            // Initialize LIFF first
            await initializeLIFF();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96ddeca7d019d032',t:'MTc1NDk4MDIzMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
